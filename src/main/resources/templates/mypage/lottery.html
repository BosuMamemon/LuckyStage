<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      layout:decorate="~{layout/layout.html}" lang="en">

<head>
    <title>ì¶”ì²¨ ê²°ê³¼</title>
</head>

<body>
<div layout:fragment="content">

    <h1 class="section-title">ğŸŸï¸ ì¶”ì²¨ ê²°ê³¼</h1>

    <div style="text-align:center; margin-top:50px;">
        <h2 id="nowTime">í˜„ì¬ ì‹œê°„: </h2>
        <h2 id="dDay"></h2>
        <h2 id="lotteryStatus" style="margin-top:20px;">ì¶”ì²¨ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...</h2>
    </div>

</div>

<script layout:fragment="script" th:inline="javascript">
    document.addEventListener("DOMContentLoaded", function () {
        const ticketId = [[${ticket.id}]];
        const selectedDate = [[${#temporals.format(ticket.selectedDate, 'yyyy-MM-dd')}]];
        const concertTitle = /*[[${ticket.concerts.title}]]*/ 'ê³µì—° ì œëª©'; // ë°±ì—…ìš©
        const lotteryKey = "lottery_" + ticketId;

        const concertDate = new Date(selectedDate);
        const lotteryDate = new Date(concertDate.getTime() - 3 * 24 * 60 * 60 * 1000);

        const nowTime = document.getElementById('nowTime');
        const dDay = document.getElementById('dDay');
        const lotteryStatus = document.getElementById('lotteryStatus');

        function updateClockAndLottery() {
            const now = new Date(new Date().toLocaleString("en-US", { timeZone: "Asia/Seoul" }));
            nowTime.textContent = "í˜„ì¬ ì‹œê°„: " + now.toLocaleString('ko-KR');

            const diff = lotteryDate.getTime() - now.getTime();
            const days = Math.ceil(diff / (1000 * 60 * 60 * 24));

            if (days > 0) {
                dDay.textContent = `â³ D-${days} (ì¶”ì²¨ê¹Œì§€ ë‚¨ì€ ì¼ìˆ˜)`;
                lotteryStatus.textContent = "â³ ì¶”ì²¨ ëŒ€ê¸° ì¤‘ì…ë‹ˆë‹¤...";
            } else {
                dDay.textContent = "ğŸ¯ ì¶”ì²¨ì¼ì…ë‹ˆë‹¤!";
                if (!localStorage.getItem(lotteryKey)) {
                    const result = Math.random() < 0.5
                        ? `ğŸ‰ ${concertTitle}ì— ë‹¹ì²¨ë˜ì—ˆìŠµë‹ˆë‹¤!`
                        : `ğŸ˜¢ ${concertTitle}ì€ ì•„ì‰½ê²Œë„ íƒˆë½ì…ë‹ˆë‹¤.`;
                    localStorage.setItem(lotteryKey, result);
                }
                lotteryStatus.textContent = localStorage.getItem(lotteryKey);
            }
        }

        updateClockAndLottery();
        setInterval(updateClockAndLottery, 1000);
    });
</script>


</body>
</html>
