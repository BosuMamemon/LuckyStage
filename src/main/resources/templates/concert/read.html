<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org/"
      xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security"
      layout:decorate="~{layout/layout.html}"
      lang="en">

<div layout:fragment="content">
  <input type="hidden" id="username" th:value="${#authentication.principal.username}" sec:authorize="isAuthenticated()">
  <h1 class="section-title">ê³µì—° ìƒì„¸</h1>

  <div class="container mt-5">

    <div class="row">

      <!-- ê³µì—° í¬ìŠ¤í„° -->
      <div class="col" style="position: relative;">
        <button type="button" class="like-btn-read"
                th:classappend="${bookmarkList.contains(concert.concertNum) ? 'active' : ''}"
                th:data-concertnum="${concert.concertNum}"
                sec:authorize="isAuthenticated()">
          â™¥
        </button>
        <img th:src="|/concert/img/${concert.posterFileName}|" class="rounded" style="width: 100%;">
      </div>

      <!-- ê³µì—° ìƒì„¸ì •ë³´ + ì˜ˆì•½/ë¦¬ë·° -->
      <div class="col-7">

        <!-- ê³µì—° ìƒì„¸ í…Œì´ë¸” -->
        <table class="table table-hover">
          <tr>
            <th class="table-success">ì œëª©</th>
            <td>[[${concert.title}]]</td>
          </tr>
          <tr>
            <th class="table-success">ê³µì—° ë‚ ì§œ</th>
            <td>[[${#dates.format(concert.startDate, 'yyyy-MM-dd')}]] ~ [[${#dates.format(concert.endDate, 'yyyy-MM-dd')}]]</td>
          </tr>
          <tr>
            <th class="table-success">ê³µì—° ì‹œê°„</th>
            <td>[[${concert.performanceTime}]]</td>
          </tr>
          <tr>
            <th class="table-success">ê³µì—° ì¥ì†Œ</th>
            <td>[[${concert.location}]]</td>
          </tr>
          <tr>
            <th class="table-success">ì´ìš© ê°€ëŠ¥ ì—°ë ¹</th>
            <td>[[${concert.ageRate}]]</td>
          </tr>
          <tr>
            <th class="table-success">ì¡°íšŒìˆ˜</th>
            <td>[[${concert.hitcount}]]</td>
          </tr>
          <tr>
            <th class="table-success">í‰ê·  í‰ì </th>
            <td>[[${concert.getReviewStars()}]]</td>
          </tr>
        </table>

        <!-- ì¶”ì²¨ ì•ˆë‚´ ë¬¸êµ¬ -->
        <p style="font-size: 14px; color: #333;">
          â€» ê³µì—° ì‹œì‘ <strong style="color: red;">3ì¼ì „</strong> ì¶”ì²¨ì„ í†µí•´ ë°œí‘œë©ë‹ˆë‹¤.<br>
          <span style="color: #666; font-size: 13px;">
            ex: "2025-05-05 ê³µì—° â‡’ 2025-05-02 ì¶”ì²¨ë°œí‘œì¼"
          </span>
        </p>

        <!-- ì˜ˆì•½ + ë¦¬ë·° ì¹´ë“œ -->
        <div class="row mt-4">

          <!-- ì˜ˆì•½ í¼ ì¹´ë“œ -->
          <div class="col">
            <form id="reserveForm" method="post" th:action="@{/ticket/complete}">
              <input type="hidden" name="concertNum" th:value="${concert.concertNum}">
              <div class="card shadow-sm p-4" style="height: 100%; border-radius: 16px; border: 1px solid #eee;">
                <label for="selectedDate" class="form-label mb-2" style="font-weight: bold;">
                  ğŸŸï¸ ê´€ëŒì¼ ì„ íƒ
                </label>

                <input type="date"
                       id="selectedDate"
                       name="selectedDate"
                       class="form-control mb-3"
                       th:attr="min=${#dates.format(concert.startDate, 'yyyy-MM-dd')}, max=${#dates.format(concert.endDate, 'yyyy-MM-dd')}"
                       required>

                  <button type="submit"
                          class="btn btn-success w-100 mt-2"
                          style="font-weight: bold; background-color: #006242; color: white; border-radius: 8px; padding: 10px;">
                    ì˜ˆì•½í•˜ê¸°
                  </button>
              </div>
            </form>
          </div>

          <!-- ë¦¬ë·° ëª©ë¡ ì¹´ë“œ -->
          <div class="col">
            <div class="card shadow-sm p-4" style="height: 100%; border-radius: 16px; border: 1px solid #eee; display: flex; flex-direction: column;">

              <!-- ë¦¬ë·° ëª©ë¡ í—¤ë” -->
              <div class="d-flex justify-content-between align-items-center mb-3">
                <h5 style="font-weight: bold; margin: 0;">ìµœì‹  ë¦¬ë·°</h5>
                <a th:href="@{/review/register(concertNum=${concert.concertNum})}">
                  <button type="button"
                          class="btn btn-sm"
                          style="background-color: #006242; color: white; font-weight: bold; border-radius: 8px; padding: 6px 12px;">
                    ë¦¬ë·° ì“°ê¸°
                  </button>
                </a>
              </div>

              <!-- ë¦¬ë·° ë¦¬ìŠ¤íŠ¸ -->
              <div class="review-list-container" style="flex-grow: 1; ">
                <!-- ë¦¬ë·°ê°€ ìˆì„ ë•Œ -->
                <div style="overflow-y: auto; max-height: 120px;" th:if="${reviewList != null && reviewList.size() > 0}">
                  <th:block th:each="i:${#numbers.sequence(0, T(java.lang.Math).min(5, reviewList.size() - 1))}">
                    <div class="mb-3 p-2" style="background-color: #f8f9fa; border-radius: 8px;">
                      <div style="font-size: 14px; color: #555;">[[${reviewList.get(i).nickname}]]</div>
                      <div style="font-size: 14px; color: #555;">[[${reviewList.get(i).title}]]</div>
                      <div style="font-size: 13px; color: #999;">[[${#temporals.format(reviewList.get(i).regDate, 'yyyy-MM-dd')}]]</div>
                      <div style="font-size: 15px; font-weight: bold;">[[${reviewList.get(i).getReviewStars()}]]</div>
                    </div>
                  </th:block>
                </div>
                <!-- ë¦¬ë·°ê°€ ì—†ì„ ë•Œ -->
                <div th:if="${reviewList == null || reviewList.size() <= 0}" class="text-center mt-3" style="color: #777;">
                  ë“±ë¡ëœ ë¦¬ë·°ê°€ ì—†ìŠµë‹ˆë‹¤.
                </div>
                <a th:href="@{/review/list(keyword=${concert.title})}">
                  <button type="button"
                          class="btn w-100 btn-sm mt-4"
                          style="background-color: #006242; color: white; font-weight: bold; border-radius: 8px; padding: 6px 12px;">
                    ì „ì²´ ë¦¬ë·° ë³´ê¸°
                  </button>
                </a>
              </div>

            </div>
          </div>

        </div> <!-- ì˜ˆì•½ + ë¦¬ë·° ì¹´ë“œ row ë -->

      </div> <!-- ê³µì—° ìƒì„¸ì •ë³´ col ë -->

    </div> <!-- ê³µì—° í¬ìŠ¤í„° + ìƒì„¸ì •ë³´ row ë -->

    <!-- ì¶”ê°€ ì´ë¯¸ì§€ (ì¤‘ì•™ì •ë ¬) -->
    <div class="row mt-5">
      <div class="col text-center">
        <th:block th:each="filename : ${concert.filenames}">
          <img th:src="|/concert/img/${filename}|" th:if="${filename!=''}" class="img-fluid mb-3">
        </th:block>
      </div>
    </div>

  </div> <!-- container ë -->

</div> <!-- layout:fragment ë -->


<script layout:fragment="script" th:inline="javascript">
  document.querySelector("button[type='submit']").addEventListener("click", function(e) {
    const date = document.querySelector("#selectedDate").value;
    if (!date) {
      alert("ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.");
      e.preventDefault();
      return;
    }
    document.querySelector("#selectedDateInput").value = date;
  });

  document.addEventListener("click", function(e) {
    // í´ë¦­ëœ ìš”ì†Œê°€ like-btn-list ë˜ëŠ” like-btn-read í´ë˜ìŠ¤ë¥¼ ê°€ì§€ê³  ìˆëŠ”ì§€ í™•ì¸
    if (e.target.matches(".like-btn-list, .like-btn-read")) {
      if (e.target.classList.contains("active")) {
        bookmarkDelete(e.target);
      } else {
        bookmark(e.target);
      }
    }
  });


  // í´ë¦­ ì‹œ ë¶ë§ˆí¬ ì œê±° í•¨ìˆ˜
  function bookmarkDelete(element) {
    const data = {
      "concertNum": element.getAttribute("data-concertnum"),
      "username": document.querySelector("#username").value
    };
    $.ajax({
      url: "/concert/deleteBookmark",
      method: "get",
      data: data
    })
            .done(function(resp) {
              alert("ë¶ë§ˆí¬ë¥¼ ì‚­ì œí–ˆìŠµë‹ˆë‹¤.")
              element.classList.remove("active");
            })
            .fail(function(e) {
              alert("ë¶ë§ˆí¬ ì‚­ì œ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
            });
  }

  // í´ë¦­ ì‹œ ë¶ë§ˆí¬ í•¨ìˆ˜
  function bookmark(element) {
    const data = {
      "concertNum": element.getAttribute("data-concertnum"),
      "username": document.querySelector("#username").value
    };
    $.ajax({
      url: "/concert/bookmark",
      method: "get",
      data: data
    })
            .done(function(resp) {
              alert("ê³µì—°ì„ ë¶ë§ˆí¬í–ˆìŠµë‹ˆë‹¤.")
              element.classList.add("active");
            })
            .fail(function(e) {
              alert("ë¶ë§ˆí¬ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.")
            });
  }
</script>